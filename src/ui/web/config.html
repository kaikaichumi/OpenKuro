<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuro - Settings</title>
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/components.css">
</head>
<body class="page-scroll">
    <nav id="main-nav"></nav>

    <div class="config-container" id="app">
        <h1 style="margin-bottom: 1rem; font-size: 1.3rem;" data-i18n="config.title">Settings</h1>

        <!-- Memory Stats -->
        <div class="section" id="stats-section">
            <h2 data-i18n="config.memoryStatus">Memory & Learning Status</h2>
            <div class="stats-grid stats-grid-sm" id="stats-grid">
                <div class="stat-card"><div class="value" id="stat-facts">-</div><div class="label" data-i18n="config.memories">Memories</div></div>
                <div class="stat-card"><div class="value" id="stat-pinned">-</div><div class="label" data-i18n="config.pinned">Pinned</div></div>
                <div class="stat-card"><div class="value" id="stat-importance">-</div><div class="label" data-i18n="config.avgImportance">Avg Importance</div></div>
                <div class="stat-card"><div class="value" id="stat-below">-</div><div class="label" data-i18n="config.belowThreshold">Below Threshold</div></div>
                <div class="stat-card"><div class="value" id="stat-lessons">-</div><div class="label" data-i18n="config.lessons">Lessons</div></div>
                <div class="stat-card"><div class="value" id="stat-md-size">-</div><div class="label" data-i18n="config.memoryMdSize">MEMORY.md (bytes)</div></div>
            </div>
            <div class="actions" style="margin-top: 0.75rem;">
                <button class="btn btn-sm btn-warning" data-maintenance="daily_lifecycle" data-i18n="config.runDaily">Run Daily Maintenance</button>
                <button class="btn btn-sm btn-warning" data-maintenance="weekly_lifecycle" data-i18n="config.runWeekly">Run Weekly Consolidation</button>
                <button class="btn btn-sm btn-warning" data-maintenance="organize_memory_md" data-i18n="config.organizeMemory">Organize MEMORY.md</button>
                <button class="btn btn-sm btn-warning" data-maintenance="daily_learning" data-i18n="config.runLearning">Run Learning Analysis</button>
            </div>
        </div>

        <!-- Context Compression -->
        <div class="section">
            <h2><span data-i18n="config.contextCompression">Context Compression</span> <span class="badge" id="badge-compression">ON</span></h2>
            <div class="field">
                <div class="field-label"><span data-i18n="config.enabled">Enabled</span><small data-i18n="config.ccDesc">Auto-summarize when context fills up</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cc-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.tokenBudget">Token Budget</span><small data-i18n="config.tokenBudgetDesc">Total token budget for context window</small></div>
                <div class="field-input"><input type="number" id="cc-budget" min="10000" max="1000000" step="10000"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.triggerThreshold">Trigger Threshold</span><small data-i18n="config.triggerThresholdDesc">Compress at this % of budget (0.0-1.0)</small></div>
                <div class="field-input"><input type="number" id="cc-threshold" min="0.5" max="0.95" step="0.05"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.keepRecent">Keep Recent Turns</span><small data-i18n="config.keepRecentDesc">How many recent turns to keep verbatim</small></div>
                <div class="field-input"><input type="number" id="cc-recent" min="3" max="50"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.summarizeModel">Summarize Model</span><small data-i18n="config.summarizeModelDesc">Cheap/fast model for summarization</small></div>
                <div class="field-input"><input type="text" id="cc-model"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.extractFacts">Extract Facts</span><small data-i18n="config.extractFactsDesc">Auto-save key facts to long-term memory</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cc-extract"><span class="slider"></span></label></div>
            </div>
        </div>

        <!-- Memory Lifecycle -->
        <div class="section">
            <h2><span data-i18n="config.memoryLifecycle">Memory Lifecycle</span> <span class="badge" id="badge-lifecycle">ON</span></h2>
            <div class="field">
                <div class="field-label"><span data-i18n="config.enabled">Enabled</span><small data-i18n="config.mlDesc">Decay, consolidation, and pruning</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="ml-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.decayRate">Decay Rate (lambda)</span><small data-i18n="config.decayRateDesc">Higher = faster decay (0.001-0.1)</small></div>
                <div class="field-input"><input type="number" id="ml-decay" min="0.001" max="0.1" step="0.001"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.pruneThreshold">Prune Threshold</span><small data-i18n="config.pruneThresholdDesc">Remove memories below this importance (0-1)</small></div>
                <div class="field-input"><input type="number" id="ml-prune" min="0.01" max="0.5" step="0.01"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.consolidationDistance">Consolidation Distance</span><small data-i18n="config.consolidationDistanceDesc">Merge memories with cosine distance below this</small></div>
                <div class="field-input"><input type="number" id="ml-consolidation" min="0.05" max="0.5" step="0.01"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.dailyTime">Daily Maintenance Time</span><small data-i18n="config.dailyTimeDesc">HH:MM format</small></div>
                <div class="field-input"><input type="text" id="ml-daily-time" placeholder="03:00"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.mdMaxLines">MEMORY.md Max Lines</span><small data-i18n="config.mdMaxLinesDesc">Auto-organize when exceeding</small></div>
                <div class="field-input"><input type="number" id="ml-md-max" min="50" max="1000"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.pinUserMemories">Pin User Memories</span><small data-i18n="config.pinUserMemoriesDesc">User-stored memories skip decay</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="ml-pin"><span class="slider"></span></label></div>
            </div>
        </div>

        <!-- Learning -->
        <div class="section">
            <h2><span data-i18n="config.experienceLearning">Experience Learning</span> <span class="badge" id="badge-learning">ON</span></h2>
            <div class="field">
                <div class="field-label"><span data-i18n="config.enabled">Enabled</span><small data-i18n="config.leDesc">Learn from action logs</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="le-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.maxLessons">Max Lessons</span><small data-i18n="config.maxLessonsDesc">Maximum number of stored lessons</small></div>
                <div class="field-input"><input type="number" id="le-max" min="5" max="100"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.injectTopK">Inject Top K</span><small data-i18n="config.injectTopKDesc">Inject this many lessons into context</small></div>
                <div class="field-input"><input type="number" id="le-topk" min="1" max="20"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.errorThreshold">Error Threshold</span><small data-i18n="config.errorThresholdDesc">Similar errors before creating a lesson</small></div>
                <div class="field-input"><input type="number" id="le-err" min="1" max="10"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.analysisTime">Analysis Time</span><small data-i18n="config.analysisTimeDesc">HH:MM for daily analysis</small></div>
                <div class="field-input"><input type="text" id="le-time" placeholder="04:00"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.trackModelPerf">Track Model Performance</span><small data-i18n="config.trackModelPerfDesc">Discover which models work best</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="le-track"><span class="slider"></span></label></div>
            </div>

            <!-- Current lessons -->
            <div id="lessons-container" style="margin-top: 0.75rem;">
                <h3 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;" data-i18n="config.lessonsLearned">Lessons Learned</h3>
                <div class="lessons-list" id="lessons-list"><em style="color: var(--text-muted); font-size: 0.8rem;" data-i18n="common.loading">Loading...</em></div>
            </div>
        </div>

        <!-- Code Feedback -->
        <div class="section">
            <h2><span data-i18n="config.codeFeedback">Code Feedback Loop</span> <span class="badge" id="badge-code">OFF</span></h2>
            <div class="field">
                <div class="field-label"><span data-i18n="config.enabled">Enabled</span><small data-i18n="config.cfDesc">Auto-check code after file_write</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cf-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.lintOnWrite">Lint on Write</span><small data-i18n="config.lintOnWriteDesc">Run linter (ruff/eslint) automatically</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cf-lint"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.typeCheck">Type Check on Write</span><small data-i18n="config.typeCheckDesc">Run type checker (pyright/tsc) automatically</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cf-type"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.testOnWrite">Test on Write</span><small data-i18n="config.testOnWriteDesc">Run related tests automatically</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="cf-test"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.maxAutoFix">Max Auto-Fix Rounds</span><small data-i18n="config.maxAutoFixDesc">Maximum retries for auto-fixing</small></div>
                <div class="field-input"><input type="number" id="cf-rounds" min="1" max="10"></div>
            </div>
        </div>

        <!-- Task Complexity -->
        <div class="section">
            <h2><span data-i18n="config.taskComplexity">Task Complexity</span> <span class="badge" id="badge-complexity">ON</span></h2>
            <div class="field">
                <div class="field-label"><span data-i18n="config.enabled">Enabled</span><small data-i18n="config.tcDesc">Estimate task complexity and route to appropriate models</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="tc-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.triggerMode">Trigger Mode</span><small data-i18n="config.triggerModeDesc">When to run complexity analysis</small></div>
                <div class="field-input">
                    <select id="tc-trigger">
                        <option value="auto" data-i18n="config.triggerAuto">Auto (every message)</option>
                        <option value="manual" data-i18n="config.triggerManual">Manual (on demand)</option>
                        <option value="auto_silent" data-i18n="config.triggerSilent">Auto Silent (background)</option>
                    </select>
                </div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.llmRefinement">LLM Refinement</span><small data-i18n="config.llmRefinementDesc">Use cheap model to refine ambiguous scores</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="tc-llm-refine"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.refinementModel">Refinement Model</span><small data-i18n="config.refinementModelDesc">Cheap model for score refinement (empty = auto)</small></div>
                <div class="field-input"><select id="tc-refine-model" class="model-select"></select></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.fastModel">Fast Model</span><small data-i18n="config.fastModelDesc">Model for trivial/simple tasks (empty = auto-detect)</small></div>
                <div class="field-input"><select id="tc-fast-model" class="model-select"></select></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.standardModel">Standard Model</span><small data-i18n="config.standardModelDesc">Model for moderate tasks (empty = default)</small></div>
                <div class="field-input"><select id="tc-standard-model" class="model-select"></select></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.frontierModel">Frontier Model</span><small data-i18n="config.frontierModelDesc">Model for complex/expert tasks (empty = auto-detect)</small></div>
                <div class="field-input"><select id="tc-frontier-model" class="model-select"></select></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.decomposition">Task Decomposition</span><small data-i18n="config.decompositionDesc">Split overly complex tasks into sub-tasks</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="tc-decompose"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.decomposeThreshold">Decompose Threshold</span><small data-i18n="config.decomposeThresholdDesc">Score above which tasks are decomposed (0-1)</small></div>
                <div class="field-input"><input type="number" id="tc-decompose-threshold" min="0.5" max="1.0" step="0.05"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.maxSubtasks">Max Sub-tasks</span><small data-i18n="config.maxSubtasksDesc">Maximum number of sub-tasks per decomposition</small></div>
                <div class="field-input"><input type="number" id="tc-max-subtasks" min="2" max="10"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.parallelSubtasks">Parallel Execution</span><small data-i18n="config.parallelSubtasksDesc">Run independent sub-tasks in parallel</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="tc-parallel"><span class="slider"></span></label></div>
            </div>

            <!-- ML Model Sub-section -->
            <h3 style="font-size: 0.9rem; color: var(--text-muted); margin-top: 1rem; margin-bottom: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                <span data-i18n="config.mlClassifier">Local ML Classifier</span>
                <span class="badge" id="badge-ml" style="margin-left: 0.5rem;">OFF</span>
            </h3>
            <div class="field">
                <div class="field-label"><span data-i18n="config.mlEnabled">ML Model</span><small data-i18n="config.mlEnabledDesc">Use local DistilBERT ONNX model for complexity analysis</small></div>
                <div class="field-input"><label class="toggle"><input type="checkbox" id="tc-ml-enabled"><span class="slider"></span></label></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.mlMode">Estimation Mode</span><small data-i18n="config.mlModeDesc">How to combine ML with heuristic scoring</small></div>
                <div class="field-input">
                    <select id="tc-ml-mode">
                        <option value="hybrid" data-i18n="config.mlModeHybrid">Hybrid (ML + Heuristic)</option>
                        <option value="ml_only" data-i18n="config.mlModeOnly">ML Only</option>
                        <option value="ml_refine" data-i18n="config.mlModeRefine">ML Refine (ambiguous zone)</option>
                    </select>
                </div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.mlModelPath">Model Path</span><small data-i18n="config.mlModelPathDesc">ONNX model file (empty = auto-detect)</small></div>
                <div class="field-input"><input type="text" id="tc-ml-model-path" placeholder="models/complexity_model_int8.onnx"></div>
            </div>
            <div class="field">
                <div class="field-label"><span data-i18n="config.mlTokenizerPath">Tokenizer Path</span><small data-i18n="config.mlTokenizerPathDesc">Tokenizer directory (empty = auto-detect)</small></div>
                <div class="field-input"><input type="text" id="tc-ml-tokenizer-path" placeholder="models/complexity_tokenizer/"></div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="actions" style="position: sticky; bottom: 0; background: var(--bg-primary); padding: 1rem 0;">
            <span id="save-status" style="color: var(--text-muted); font-size: 0.85rem; margin-right: auto;"></span>
            <button class="btn btn-primary" id="save-btn" disabled data-i18n="config.save">Save & Apply</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module" src="/static/js/config.js"></script>
</body>
</html>
